# 时序违例修复总结报告 (Timing Violation Fix Report)

## 1. 概述
本项目在 100MHz 时钟频率下遇到了严重的建立时间（Setup Time）违例，最差负松弛（WNS）一度达到 -12ns。经过多轮优化，主要通过**逻辑时序化**、**流水线设计**和**扇出优化**解决了这些问题。

## 2. 详细修复措施

### 2.1 Matrix ALU (算术逻辑单元)

#### A. 卷积逻辑重构 (Convolution Logic)
*   **问题描述**: 初始设计尝试在一个时钟周期内完成 3x3 卷积核与图像数据的乘加运算，导致巨大的组合逻辑链和 -12ns 的时序违例。
*   **修复方案**: 将组合逻辑改为**时序逻辑**。
    *   使用状态机控制，每个输出像素花费 9 个时钟周期进行累加计算。
    *   移除了所有深层的组合逻辑循环。

#### B. 深度流水线 (Deep Pipelining)
*   **问题描述**: 即使在普通矩阵加法和乘法中，路径 `RAM读取 -> 乘法 -> 加法 -> 饱和截断 -> RAM写入` 也过长，导致约 -4.3ns 的违例。
*   **修复方案**: 引入 **2级流水线 (Fetch-Execute Pipeline)**。
    *   **Stage 1 (Fetch)**: 根据计数器地址读取数据，锁存到中间寄存器 `op_a_reg`, `op_b_reg`。
    *   **Stage 2 (Execute)**: 执行运算（加/乘）并写入结果。
*   **效果**: 将关键路径切断为两半，隔离了存储器读取延迟和计算延迟。

### 2.2 LFSR (随机数生成器)

#### A. 移除取模运算 (Modulo Removal)
*   **问题描述**: 代码中使用 `%` 运算符计算随机数范围。在硬件中，取模等同于除法，延迟极高且消耗大量 LUT 资源，导致约 -2ns 违例。
*   **修复方案**: 改用**乘法映射**算法。
    *   原逻辑: `val = rand % range`
    *   新逻辑: `val = (rand * range) >> 8`
*   **效果**: 利用 FPGA 内部的高速 DSP Slice 替代低效的除法逻辑。

#### B. 范围计算流水线化
*   **问题描述**: `range = max - min + 1` 的计算与随机数生成在同一周期，增加了路径延迟。
*   **修复方案**: 增加流水线级数。
    *   **Stage 0**: 预计算 `range_len_reg`。
    *   **Stage 1**: 计算乘法偏移量。
    *   **Stage 2**: 输出最终结果。

### 2.3 Matrix Storage (存储系统)

#### A. 高扇出信号优化 (High Fanout Optimization)
*   **问题描述**: `latched_wr_id` 和 `wr_target_id_reg` 等控制信号需要驱动整个矩阵存储阵列，扇出过大导致布线延迟过高。
*   **修复方案**: 添加 Synthesis Attribute。
    *   代码: `(* max_fanout = 20 *) reg [MAT_ID_W-1:0] latched_wr_id;`
*   **效果**: 强制综合工具复制寄存器，降低单个寄存器的负载，缩短布线距离。

## 3. 总结
通过上述措施，我们将原本单周期内过于复杂的逻辑拆分到了多个时钟周期内执行（空间换时间），并利用 FPGA 擅长的乘法器替代了除法器。目前的架构在保持功能不变的前提下，显著提升了系统的最高运行频率（Fmax）。
